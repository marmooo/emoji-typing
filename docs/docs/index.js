const remSize=parseInt(getComputedStyle(document.documentElement).fontSize),gamePanel=document.getElementById("gamePanel"),playPanel=document.getElementById("playPanel"),infoPanel=document.getElementById("infoPanel"),countPanel=document.getElementById("countPanel"),scorePanel=document.getElementById("scorePanel"),aaOuter=document.getElementById("aaOuter"),startButton=document.getElementById("startButton"),romaNode=document.getElementById("roma"),originalTextNode=document.getElementById("originalText"),translatedTextNode=document.getElementById("translatedText"),aa=document.getElementById("aa"),gameTime=60,tmpCanvas=document.createElement("canvas"),mode=document.getElementById("mode"),categories=[...document.getElementById("courseOption").options].map(e=>e.value.toLowerCase()),problems={},originalLang=document.documentElement.lang,ttsLang=getTTSLang();let typeTimer;const bgm=new Audio("/emoji-typing/mp3/bgm.mp3");bgm.volume=.4,bgm.loop=!0;let typeIndex=0,errorCount=0,normalCount=0,solveCount=0,englishVoices=[],guide=!0,keyboardAudio,correctAudio,incorrectAudio,endAudio;loadAudios();const AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext,layout104={default:["{esc} ` 1 2 3 4 5 6 7 8 9 0 -","{tab} q w e r t y u i o p [ ]","{lock} a s d f g h j k l ;","{shift} z x c v b n m , .","üåè {altLeft} {space} {altRight}"],shift:["{esc} ~ ! @ # $ % ^ & * ( ) _","{tab} Q W E R T Y U I O P { }","{lock} A S D F G H J K L :","{shift} Z X C V B N M < >","üåè {altLeft} {space} {altRight}"]},layout109={default:["{esc} 1 2 3 4 5 6 7 8 9 0 -","{tab} q w e r t y u i o p","{lock} a s d f g h j k l ;","{shift} z x c v b n m , .","üåè ÁÑ°Â§âÊèõ {space} Â§âÊèõ"],shift:[`{esc} ! " # $ % & ' ( ) =`,"{tab} Q W E R T Y U I O P","{lock} A S D F G H J K L +","{shift} Z X C V B N M < >","üåè ÁÑ°Â§âÊèõ {space} Â§âÊèõ"]},keyboardDisplay={"{esc}":"Esc","{tab}":"Tab","{lock}":"Caps","{shift}":"Shift","{space}":" ","{altLeft}":"Alt","{altRight}":"Alt","üåè":originalLang=="ja"?"üáØüáµ":"üá∫üá∏"},simpleKeyboard=new SimpleKeyboard.default({layout:originalLang=="ja"?layout109:layout104,display:keyboardDisplay,onInit:()=>{document.getElementById("keyboard").classList.add("d-none")},onKeyPress:e=>{switch(e){case"{esc}":return typeEventKey("Escape");case"{space}":return typeEventKey(" ");case"ÁÑ°Â§âÊèõ":case"{altLeft}":return typeEventKey("NonConvert");case"Â§âÊèõ":case"{altRight}":return typeEventKey("Convert");case"üåè":{simpleKeyboard.options.layout==layout109?(keyboardDisplay["üåè"]="üá∫üá∏",simpleKeyboard.setOptions({layout:layout104,display:keyboardDisplay})):(keyboardDisplay["üåè"]="üáØüáµ",simpleKeyboard.setOptions({layout:layout109,display:keyboardDisplay}));break}case"{shift}":case"{lock}":{const e=simpleKeyboard.options.layoutName=="default"?"shift":"default";simpleKeyboard.setOptions({layoutName:e});break}default:return typeEventKey(e)}}});loadConfig();function loadConfig(){if(localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark"),localStorage.getItem("bgm")!=1&&(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none")),originalLang=="ja"&&localStorage.getItem("furigana")==1){const e=document.getElementById("addFurigana");addFurigana(e),e.setAttribute("data-done",!0)}}function toggleBGM(){localStorage.getItem("bgm")==1?(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"),localStorage.setItem("bgm",0),bgm.pause()):(document.getElementById("bgmOn").classList.remove("d-none"),document.getElementById("bgmOff").classList.add("d-none"),localStorage.setItem("bgm",1),bgm.play())}function toggleKeyboard(){const e=document.getElementById("virtualKeyboardOn"),t=document.getElementById("virtualKeyboardOff");e.classList.contains("d-none")?(e.classList.remove("d-none"),t.classList.add("d-none"),document.getElementById("keyboard").classList.remove("d-none"),resizeFontSize(aa)):(e.classList.add("d-none"),t.classList.remove("d-none"),document.getElementById("keyboard").classList.add("d-none"),document.getElementById("guideSwitch").checked=!1,guide=!1,resizeFontSize(aa))}function toggleGuide(){this.checked?guide=!0:guide=!1}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}function addFurigana(){if(originalLang!="ja")return;const e=document.getElementById("addFurigana");e.getAttribute("data-done")?(localStorage.setItem("furigana",0),location.reload()):(import("https://marmooo.github.io/yomico/yomico.min.js").then(e=>{e.yomico("/emoji-typing/ja/index.yomi")}),localStorage.setItem("furigana",1),e.setAttribute("data-done",!0))}function changeLang(){const e=document.getElementById("lang"),t=e.options[e.selectedIndex].value;location.href=`/emoji-typing/${t}/`}function getTTSLang(){switch(originalLang){case"en":return"en-US";case"ja":return"ja-JP"}}function playAudio(e,t){const n=audioContext.createBufferSource();if(n.buffer=e,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}function unlockAudio(){audioContext.resume()}function loadAudio(e){return fetch(e).then(e=>e.arrayBuffer()).then(e=>new Promise((t,n)=>{audioContext.decodeAudioData(e,e=>{t(e)},e=>{n(e)})}))}function loadAudios(){promises=[loadAudio("/emoji-typing/mp3/keyboard.mp3"),loadAudio("/emoji-typing/mp3/correct.mp3"),loadAudio("/emoji-typing/mp3/cat.mp3"),loadAudio("/emoji-typing/mp3/end.mp3")],Promise.all(promises).then(e=>{keyboardAudio=e[0],correctAudio=e[1],incorrectAudio=e[2],endAudio=e[3]})}function loadVoices(){const e=new Promise(e=>{let t=speechSynthesis.getVoices();if(t.length!==0)e(t);else{let n=!1;speechSynthesis.addEventListener("voiceschanged",()=>{n=!0,t=speechSynthesis.getVoices(),e(t)}),setTimeout(()=>{n||document.getElementById("noTTS").classList.remove("d-none")},1e3)}});e.then(e=>{englishVoices=e.filter(e=>e.lang==ttsLang)})}loadVoices();function loopVoice(e,t){speechSynthesis.cancel();const n=new SpeechSynthesisUtterance(e);n.voice=englishVoices[Math.floor(Math.random()*englishVoices.length)],n.lang=ttsLang;for(let e=0;e<t;e++)speechSynthesis.speak(n)}function fixTypeStyle(e,t){removeGuide(e),e.textContent=t,typeNormal(e)}function appendWord(e,t){removeGuide(e);const n=document.createElement("span");n.textContent=t,e.parentNode.insertBefore(n,e.nextSibling)}function checkTypeStyle(e,t,n,s){const c=["i","e"],r=["a","u","o"],l=["a","u","e","o"],h=["a","i","u","e","o"],d=s.childNodes,a=d[typeIndex+1];let o;a&&(o=a.textContent);let i;typeIndex!=0&&(i=d[typeIndex-1].textContent);let u;if(d[typeIndex+2]&&(u=d[typeIndex+2].textContent),n=="k"&&t=="c"&&r.includes(o))fixTypeStyle(e,n);else if(n=="c"&&t=="k"&&r.includes(o))fixTypeStyle(e,n);else if(n=="h"&&i=="s"&&t=="i")fixTypeStyle(e,n),appendWord(e,"i");else if(n=="i"&&i=="s"&&t=="h"&&o=="i")fixTypeStyle(e,n),o&&a.remove();else if(n=="c"&&t=="s"&&c.includes(o))fixTypeStyle(e,n);else if(n=="s"&&t=="c"&&c.includes(o))fixTypeStyle(e,n);else if(n=="j"&&t=="z"&&o=="i")fixTypeStyle(e,n);else if(n=="z"&&t=="j"&&o=="i")fixTypeStyle(e,n);else if(n=="c"&&t=="t"&&o=="i")fixTypeStyle(e,n),appendWord(e,"h");else if(n=="t"&&t=="c"&&o=="h"&&u=="i")fixTypeStyle(e,n),o&&a.remove();else if(n=="s"&&i=="t"&&t=="u")fixTypeStyle(e,n),appendWord(e,"u");else if(n=="u"&&i=="t"&&t=="s"&&o=="u")fixTypeStyle(e,n),o&&a.remove();else if(n=="f"&&t=="h"&&o=="u")fixTypeStyle(e,n);else if(n=="h"&&t=="f"&&o=="u")fixTypeStyle(e,n);else if(n=="x"&&t=="n"&&o=="n")fixTypeStyle(e,n);else if(n=="n"&&t=="x"&&o=="n")fixTypeStyle(e,n);else if(n=="l"&&t=="x"&&h.includes(o))fixTypeStyle(e,n);else if(n=="x"&&t=="l"&&h.includes(o))fixTypeStyle(e,n);else if(n=="x"&&t=="l"&&o=="y"&&r.includes(o))fixTypeStyle(e,n);else if(n=="h"&&i=="w"&&c.includes(t))fixTypeStyle(e,n),appendWord(e,t);else if(c.includes(n)&&i=="w"&&t=="h"&&c.includes(o))fixTypeStyle(e,n),o&&a.remove();else if(n=="h"&&i=="s"&&t=="y"&&l.includes(o))fixTypeStyle(e,n);else if(n=="y"&&i=="s"&&t=="h"&&l.includes(o))fixTypeStyle(e,n);else if(n=="j"&&t=="z"&&o=="y"&&r.includes(u))fixTypeStyle(e,n),o&&a.remove();else if(n=="z"&&t=="j"&&r.includes(o))fixTypeStyle(e,n),appendWord(e,"y");else if(n=="j"&&t=="z"&&o=="y")fixTypeStyle(e,n);else if(r.includes(n)&&i=="j"&&t=="y"&&r.includes(o))fixTypeStyle(e,n),o&&a.remove();else if(n=="y"&&i=="j"&&r.includes(t))fixTypeStyle(e,n),appendWord(e,o);else if(n=="z"&&t=="j"&&o=="y")fixTypeStyle(e,n);else if(n=="t"&&t=="c"&&o=="y")fixTypeStyle(e,n);else if(n=="c"&&t=="t"&&o=="y")fixTypeStyle(e,n);else if(n=="t"&&t=="c"&&o=="h"&&l.includes(o))fixTypeStyle(e,n),a.textContent="y";else if(n=="h"&&i=="c"&&t=="y"&&l.includes(o))fixTypeStyle(e,n),a.textContent=o;else if(n=="y"&&i=="c"&&t=="h"&&l.includes(o))fixTypeStyle(e,n),a.textContent=o;else return!1;return!0}function typeNormal(e){e.style.visibility="visible",playAudio(keyboardAudio),e.style.color="silver",typeIndex+=1,normalCount+=1}function underlineSpace(e){e.textContent==" "&&e.style.removeProperty("text-decoration");const t=e.nextElementSibling;t&&t.textContent==" "&&(t.style.textDecoration="underline")}function nextProblem(){playAudio(correctAudio),typeIndex=0,solveCount+=1,typable()}function removeGuide(e){const n=e.previousSiblingElement;if(n){const e=n.textContent,t=simpleKeyboard.getButtonElement(e);t.classList.remove("bg-info")}let t=e.textContent;t==" "&&(t="{space}");const s=simpleKeyboard.getButtonElement(t);s&&s.classList.remove("bg-info")}function showGuide(e){if(guide){const n=e.textContent,t=simpleKeyboard.getButtonElement(n);t&&t.classList.add("bg-info")}}function typeEvent(e){switch(e.code){case"AltLeft":return typeEventKey("NonConvert");case"AltRight":return typeEventKey("Convert");case"Space":e.preventDefault();default:return typeEventKey(e.key)}}function typeEventKey(e){const t=romaNode.childNodes[typeIndex];if(/^[^0-9]$/.test(e)){if(e==t.textContent)typeNormal(t),removeGuide(t),underlineSpace(t);else{const n=checkTypeStyle(t,t.textContent,e,romaNode);n||(playAudio(incorrectAudio,.3),errorCount+=1)}typeIndex==romaNode.childNodes.length?nextProblem():showGuide(romaNode.childNodes[typeIndex])}else switch(e){case"NonConvert":{[...romaNode.children].forEach(e=>{e.style.visibility="visible"}),downTime(5);break}case"Convert":{const e=originalTextNode.textContent;loopVoice(e.toLowerCase(),1);break}case"Escape":replay();break}}function resizeFontSize(e){function h(e,t){const n=tmpCanvas.getContext("2d");n.font=t;const s=n.measureText(e);return s.width}function f(e,t,n,s){const o=e.split(`
`),a=t+"px "+n;let i=0;for(let e=0;e<o.length;e++){const t=h(o[e],a);i<t&&(i=t)}return[i,t*o.length*s]}function m(e){const t=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),n=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom);return[t,n]}const n=getComputedStyle(e),c=n.fontFamily,t=parseFloat(n.fontSize),l=parseFloat(n.lineHeight)/t,d=aaOuter.offsetHeight,u=infoPanel.clientWidth,i=[u,d],a=f(e.textContent,t,c,l),r=m(n),o=t*(i[0]-r[0])/a[0]*.9,s=t*(i[1]-r[1])/a[1]*.9;s<o?s<remSize?e.style.fontSize=remSize+"px":e.style.fontSize=s+"px":o<remSize?e.style.fontSize=remSize+"px":e.style.fontSize=o+"px"}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}function typable(){const i=document.getElementById("courseOption"),a=categories[i.selectedIndex],n=problems[a],e=n[getRandomInt(0,n.length)],s=e[0];aa.textContent=s[getRandomInt(0,s.length)];const t=e[1],r=e[2],o=e[3];for(romaNode.textContent=t,originalTextNode.textContent=r,translatedTextNode.textContent=o,mode.textContent=="EASY"&&loopVoice(o,1);romaNode.firstChild;)romaNode.removeChild(romaNode.firstChild);for(let e=0;e<t.length;e++){const n=document.createElement("span");mode.textContent!="EASY"&&(n.style.visibility="hidden"),n.textContent=t[e],romaNode.appendChild(n)}resizeFontSize(aa),showGuide(romaNode.childNodes[0])}function countdown(){changeUIEmoji(),typeIndex=normalCount=errorCount=solveCount=0,document.getElementById("guideSwitch").disabled=!0,document.getElementById("virtualKeyboard").disabled=!0,gamePanel.classList.add("d-none"),countPanel.classList.remove("d-none"),counter.textContent=3;const e=setInterval(()=>{const t=document.getElementById("counter"),n=["skyblue","greenyellow","violet","tomato"];if(parseInt(t.textContent)>1){const e=parseInt(t.textContent)-1;t.style.backgroundColor=n[e],t.textContent=e}else clearInterval(e),document.getElementById("guideSwitch").disabled=!1,document.getElementById("virtualKeyboard").disabled=!1,gamePanel.classList.remove("d-none"),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),playPanel.classList.remove("d-none"),aaOuter.classList.remove("d-none"),scorePanel.classList.add("d-none"),resizeFontSize(aa),typable(),startTypeTimer(),localStorage.getItem("bgm")==1&&bgm.play(),document.addEventListener("keydown",typeEvent),startButton.disabled=!1},1e3)}function replay(){clearInterval(typeTimer),removeGuide(romaNode.childNodes[typeIndex]),document.removeEventListener("keydown",typeEvent),document.getElementById("time").textContent=gameTime,countdown(),typeIndex=normalCount=errorCount=solveCount=0,countPanel.classList.remove("d-none"),scorePanel.classList.add("d-none")}function startKeyEvent(e){e.key==" "&&(e.preventDefault(),document.removeEventListener("keydown",startKeyEvent),replay())}function startTypeTimer(){const e=document.getElementById("time");typeTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(typeTimer),bgm.pause(),playAudio(endAudio),scoring())},1e3)}function downTime(e){const t=document.getElementById("time"),s=parseInt(t.textContent),n=s-e;n<0?t.textContent=0:t.textContent=n}function scoring(){infoPanel.classList.remove("d-none"),playPanel.classList.add("d-none"),aaOuter.classList.add("d-none"),countPanel.classList.add("d-none"),scorePanel.classList.remove("d-none"),document.removeEventListener("keydown",typeEvent);let e=parseInt(document.getElementById("time").textContent);e<gameTime&&(e=gameTime-e);const t=(normalCount/e).toFixed(2);document.getElementById("totalType").textContent=normalCount+errorCount,document.getElementById("typeSpeed").textContent=t,document.getElementById("errorType").textContent=errorCount,document.addEventListener("keydown",startKeyEvent)}function changeMode(){this.textContent=="EASY"?this.textContent="HARD":this.textContent="EASY"}function selectRandomEmoji(){const s=categories[getRandomInt(0,categories.length)],e=problems[s],t=e[getRandomInt(0,e.length)],n=t[0],o=n[getRandomInt(0,n.length)],i=t[1];return[o,i]}function changeUIEmoji(){document.getElementById("counter-emoji").textContent=selectRandomEmoji()[0],document.getElementById("score-emoji").textContent=selectRandomEmoji()[0]}function initProblems(){fetch(`/emoji-typing/data/${originalLang}.csv`).then(e=>e.text()).then(e=>{let t;e.trimEnd().split(`
`).forEach(e=>{const[o,s,n,i,a]=e.split(",");if(s in problems===!1&&(problems[s]=[]),t==n){const e=problems[s],t=e[e.length-1];t[0].push(o)}else originalLang=="en"?problems[s].push([[o],n,n,n]):problems[s].push([[o],n,i,a]);t=n})})}function setTranslation(){const e={attributeFilter:["lang"],attributes:!0};new MutationObserver(()=>{originalLang=="en"?originalTextNode.classList.add("d-none"):originalTextNode.classList.remove("d-none");const e=document.documentElement.lang;e==originalLang?translatedTextNode.classList.add("d-none"):translatedTextNode.classList.remove("d-none")}).observe(document.documentElement,e)}resizeFontSize(aa),initProblems(),setTranslation(),startButton.onclick=replay,document.getElementById("toggleDarkMode").onclick=toggleDarkMode;const furiganaButton=document.getElementById("addFurigana");furiganaButton&&(furiganaButton.onclick=addFurigana),document.getElementById("toggleBGM").onclick=toggleBGM,document.getElementById("virtualKeyboard").onclick=toggleKeyboard,window.addEventListener("resize",()=>{resizeFontSize(aa)}),document.getElementById("mode").onclick=changeMode,document.getElementById("guideSwitch").onchange=toggleGuide,document.getElementById("lang").onchange=changeLang,document.addEventListener("keydown",startKeyEvent),document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})