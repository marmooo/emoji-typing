class t{constructor(){this.children=new Map,this.isEnd=!1}getFirstBranch(){return function(e){let t="";for(;!e.isEnd;){const n=e.children.keys().next().value;t+=n,e=e.children.get(n)}return t}(this)}getSuffixes(){const e=[];return function t(n,s){n.isEnd&&e.push(s);for(const[e,o]of n.children.entries())t(o,s+e)}(this,""),e}}class e{constructor(){this.root=new t}set(e){let n=this.root;for(let s=0;s<e.length;s++){const o=e[s];n.children.has(o)||n.children.set(o,new t),n=n.children.get(o)}n.isEnd=!0}get(e){let t=this.root;for(let n=0;n<e.length;n++){const s=e[n];if(!t.children.has(s))return null;t=t.children.get(s)}return t}}class i{get inputedHiragana(){let e="";for(let t=0;t<this.laticeIndex;t++)e+=this.latice[t].hiragana;if(e.endsWith("„Å£")){const t=this.inputedRomaji.match(i.hatsuonRegexp)[0].length;e=e.replace(i.hatsuonRegexp,"„Å£".repeat(t-1))}return e}get remainedRomaji(){const e=this.currentNode;return(e?e.getFirstBranch():"")+this.latice.slice(this.laticeIndex+1).map(e=>e.root.getFirstBranch()).join("")}get remainedHiragana(){return this.hiragana.slice(this.inputedHiragana.length)}constructor(e,t={}){this.hiragana=e,this.options=t||{},this.options.shortSokuon=t.shortSokuon??!0,this.options.shortHatsuon=t.shortHatsuon??!0,this.latice=this.toLatice(e),this.laticeIndex=0,this.currentNode=this.latice[0].root,this.inputedRomaji=""}toLatice(e){const t=[];return e.match(i.wordRegexp).forEach(e=>{if(e.match(i.hiraganaRegexp)){const n=this.toHiraganaLatice(e);t.push(...n)}else{const n=this.toAsciiLatice(e);t.push(...n)}}),t}toAsciiLatice(t){const n=[];return Array.from(t).forEach(t=>{const s=new e;s.set(t),n.push(s)}),n}toHiraganaLatice(t){const n=[],s=t.match(i.segmentRegexp);for(const t of s){const o=t.lastIndexOf("„Å£");if(t.length>1&&o>=0){const s=t.slice(o+1);if(this.options.shortSokuon&&s.length>0){const t=new e;t.hiragana=s,this.getRomajiPattern(s).forEach(e=>{t.set(e)});const a=Array.from(t.root.children.keys());for(let r=0;r<=o;r++){const t=new e;t.hiragana="„Å£",s[0].match(i.nagyoRegexp)||a.forEach(e=>{t.set(e)}),this.getRomajiPattern("„Å£").forEach(e=>{t.set(e)}),n.push(t)}n.push(t)}else for(let s=0;s<=o;s++){const t=new e;t.hiragana="„Å£",this.getRomajiPattern("„Å£").forEach(e=>{t.set(e)}),n.push(t)}}else{const s=new e;s.hiragana=t,this.getRomajiPattern(t).forEach(e=>{s.set(e)}),n.push(s)}}return n}input(e){if(!this.currentNode)return!1;const t=this.currentNode.children.get(e);if(t)return t.isEnd?(this.laticeIndex+=1,this.laticeIndex>=this.latice.length?this.currentNode=null:this.currentNode=this.latice[this.laticeIndex].root):this.currentNode=t,this.inputedRomaji+=e,!0;switch(this.latice[this.laticeIndex].hiragana){case"„Çì":{if(!this.options.shortHatsuon)return!1;if(!this.inputedRomaji.at(-1).match(/[xn]/))return!1;if(e.match(/[aiueoy]/))return!1;if(this.laticeIndex+1>=this.latice.length)return!1;const t=this.latice[this.laticeIndex+1].root.children.get(e);return!!t&&(this.laticeIndex+=1,this.currentNode=t,this.inputedRomaji+=e,!0)}case"„Å£":{if(!this.options.shortSokuon)return!1;if(this.inputedRomaji.at(-1)!==e)return!1;if(e.match(/[aiueon]/))return!1;if(this.laticeIndex+1>=this.latice.length)return!1;const t=this.latice[this.laticeIndex+1].root.children.get(e);return!!t&&(this.laticeIndex+=1,this.currentNode=t,this.inputedRomaji+=e,!0)}}return!1}isEnd(){return!this.currentNode}getCombinations(e,t=[]){if(t.length===e.length)return[t.join("")];const n=[];for(const s of e[t.length])n.push(...this.getCombinations(e,[...t,s]));return n}get2gramPattern(e){const s=i.table[e[0]],n=i.table[e[1]],t=this.getCombinations([s,n]);if("„Å£"===e[0]){if(i.nagyoRegexp.test(e[1]))return t;{const e=n.map(e=>e[0]+e);return e.push(...t),e}}{const n=i.table[e]||[];return n.push(...t),n}}get3gramPattern(e){const s=i.table[e[0]],o=i.table[e[1]],a=i.table[e[2]],t=i.table[e.slice(1)],n=t?this.getCombinations([s,t]):[],r=this.getCombinations([s,o,a]);if(i.nagyoRegexp.test(e[1]))return n.push(...r),n;{const e=t?t.map(e=>e[0]+e):[],s=o.map(e=>e[0]+e),i=this.getCombinations([s,a]);return e.push(...i),e.push(...n),e.push(...r),e}}getRomajiPattern(e){switch(e.length){case 1:return i.table[e];case 2:return this.get2gramPattern(e);case 3:return this.get3gramPattern(e);default:throw new Error("parse error")}}}Object.defineProperty(i,"wordRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/([„ÅÅ-„Çñ„Éº]+|[ -~]+)/g}),Object.defineProperty(i,"hiraganaRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/[„ÅÅ-„Çñ„Éº]+/g}),Object.defineProperty(i,"segmentRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/„Å£*[„ÅÅ-„Çñ„Éº][„ÅÅ„ÅÉ„ÅÖ„Åá„Åâ„ÇÉ„ÇÖ„Çá]?/g}),Object.defineProperty(i,"nagyoRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/[„Å™„Å´„Å¨„Å≠„ÅÆ„Çì]/}),Object.defineProperty(i,"hatsuonRegexp",{enumerable:!0,configurable:!0,writable:!0,value:/(.)\1*$/}),Object.defineProperty(i,"table",{enumerable:!0,configurable:!0,writable:!0,value:{"„Éº":["-"],"„ÅÑ„Åá":["ye"],"„ÅÜ„ÅÅ":["wha"],"„ÅÜ„ÅÉ":["wi","whi"],"„ÅÜ„Åá":["we","whe"],"„ÅÜ„Åâ":["who"],"„Çî„ÅÅ":["va"],"„Çî„ÅÉ":["vi","vyi"],"„Çî„Åá":["ve","vye"],"„Çî„Åâ":["vo"],"„Çî„ÇÉ":["vya"],"„Çî„ÇÖ":["vyu"],"„Çî„Çá":["vyo"],"„Åç„ÇÉ":["kya"],"„Åç„ÅÉ":["kyi"],"„Åç„ÇÖ":["kyu"],"„Åç„Åá":["kye"],"„Åç„Çá":["kyo"],"„Åé„ÇÉ":["gya"],"„Åé„ÅÉ":["gyi"],"„Åé„ÇÖ":["gyu"],"„Åé„Åá":["gye"],"„Åé„Çá":["gyo"],"„Åè„ÅÅ":["kwa","qa"],"„Åè„ÅÉ":["kwi","qi"],"„Åè„ÅÖ":["kwu"],"„Åè„Åá":["kwe","qe"],"„Åè„Åâ":["kwo","qo"],"„Åè„ÇÉ":["qya"],"„Åè„ÇÖ":["qyu"],"„Åè„Çá":["qyo"],"„Åê„ÅÅ":["gwa"],"„Åê„ÅÉ":["gwi"],"„Åê„ÅÖ":["gwu"],"„Åê„Åá":["gwe"],"„Åê„Åâ":["gwo"],"„Åó„ÇÉ":["sha","sya"],"„Åó„ÅÉ":["syi"],"„Åó„ÇÖ":["shu","syu"],"„Åó„Åá":["she","sye"],"„Åó„Çá":["sho","syo"],"„Åò„ÇÉ":["ja","jya","zya"],"„Åò„ÅÉ":["jyi","zyi"],"„Åò„ÇÖ":["ju","jyu","zyu"],"„Åò„Åá":["je","jye","zye"],"„Åò„Çá":["jo","jyo","zyo"],"„Åô„ÅÅ":["swa"],"„Åô„ÅÉ":["swi"],"„Åô„ÅÖ":["swu"],"„Åô„Åá":["swe"],"„Åô„Åâ":["swo"],"„Å°„ÇÉ":["cha","cya","tya"],"„Å°„ÅÉ":["cyi","tyi"],"„Å°„ÇÖ":["chu","cyu","tyu"],"„Å°„Åá":["che","cye","tye"],"„Å°„Çá":["cho","cyo","tyo"],"„Å¢„ÇÉ":["dya"],"„Å¢„ÅÉ":["dyi"],"„Å¢„ÇÖ":["dyu"],"„Å¢„Åá":["dye"],"„Å¢„Çá":["dyo"],"„Å§„ÅÅ":["tsa"],"„Å§„ÅÉ":["tsi"],"„Å§„Åá":["tse"],"„Å§„Åâ":["tso"],"„Å¶„ÇÉ":["tha"],"„Å¶„ÅÉ":["thi"],"„Å¶„ÇÖ":["thu"],"„Å¶„Åá":["the"],"„Å¶„Çá":["tho"],"„Åß„ÇÉ":["dha"],"„Åß„ÅÉ":["dhi"],"„Åß„ÇÖ":["dhu"],"„Åß„Åá":["dhe"],"„Åß„Çá":["dho"],"„Å®„ÅÅ":["twa"],"„Å®„ÅÉ":["twi"],"„Å®„ÅÖ":["twu"],"„Å®„Åá":["twe"],"„Å®„Åâ":["two"],"„Å©„ÅÅ":["dwa"],"„Å©„ÅÉ":["dwi"],"„Å©„ÅÖ":["dwu"],"„Å©„Åá":["dwe"],"„Å©„Åâ":["dwo"],"„Å´„ÇÉ":["nya"],"„Å´„ÅÉ":["nyi"],"„Å´„ÇÖ":["nyu"],"„Å´„Åá":["nye"],"„Å´„Çá":["nyo"],"„Å≤„ÇÉ":["hya"],"„Å≤„ÅÉ":["hyi"],"„Å≤„ÇÖ":["hyu"],"„Å≤„Åá":["hye"],"„Å≤„Çá":["hyo"],"„Å≥„ÇÉ":["bya"],"„Å≥„ÅÉ":["byi"],"„Å≥„ÇÖ":["byu"],"„Å≥„Åá":["bye"],"„Å≥„Çá":["byo"],"„Å¥„ÇÉ":["pya"],"„Å¥„ÅÉ":["pyi"],"„Å¥„ÇÖ":["pyu"],"„Å¥„Åá":["pye"],"„Å¥„Çá":["pyo"],"„Åµ„ÅÅ":["fa","fwa","hwa"],"„Åµ„ÅÉ":["fi","fwi","fyi","hwi"],"„Åµ„ÅÖ":["fwu"],"„Åµ„Åá":["fe","fwe","fye","hwe"],"„Åµ„Åâ":["fo","fwo","hwo"],"„Åµ„ÇÉ":["fya"],"„Åµ„ÇÖ":["fyu"],"„Åµ„Çá":["fyo"],"„Åø„ÇÉ":["mya"],"„Åø„ÅÉ":["myi"],"„Åø„ÇÖ":["myu"],"„Åø„Åá":["mye"],"„Åø„Çá":["myo"],"„Çä„ÇÉ":["rya"],"„Çä„ÅÉ":["ryi"],"„Çä„ÇÖ":["ryu"],"„Çä„Åá":["rye"],"„Çä„Çá":["ryo"],"„ÅÇ":["a"],"„ÅÑ":["i"],"„ÅÜ":["u","whu","wu"],"„Åà":["e"],"„Åä":["o"],"„Åã":["ka","ca"],"„Åç":["ki"],"„Åè":["ku","cu","qu"],"„Åë":["ke"],"„Åì":["ko","co"],"„Åï":["sa"],"„Åó":["shi","si","ci"],"„Åô":["su"],"„Åõ":["se","ce"],"„Åù":["so"],"„Åü":["ta"],"„Å°":["chi","ti"],"„Å§":["tsu","tu"],"„Å¶":["te"],"„Å®":["to"],"„Å™":["na"],"„Å´":["ni"],"„Å¨":["nu"],"„Å≠":["ne"],"„ÅÆ":["no"],"„ÅØ":["ha"],"„Å≤":["hi"],"„Åµ":["fu","hu"],"„Å∏":["he"],"„Åª":["ho"],"„Åæ":["ma"],"„Åø":["mi"],"„ÇÄ":["mu"],"„ÇÅ":["me"],"„ÇÇ":["mo"],"„ÇÑ":["ya"],"„ÇÜ":["yu"],"„Çà":["yo"],"„Çâ":["ra"],"„Çä":["ri"],"„Çã":["ru"],"„Çå":["re"],"„Çç":["ro"],"„Çè":["wa"],"„Çí":["wo"],"„Çì":["nn","xn"],"„ÅÅ":["xa","la"],"„ÅÉ":["xi","li","xyi","lyi"],"„ÅÖ":["xu","lu"],"„Åá":["xe","le","xye","lye"],"„Åâ":["xo","lo"],"„ÇÉ":["xya","lya"],"„ÇÖ":["xyu","lyu"],"„Çá":["xyo","lyo"],"„Çï":["xka","lka"],"„Çñ":["xke","lke"],"„Å£":["xtu","xtsu","ltu","ltsu"],"„Çé":["xwa","lwa"],"„Åå":["ga"],"„Åé":["gi"],"„Åê":["gu"],"„Åí":["ge"],"„Åî":["go"],"„Åñ":["za"],"„Åò":["ji","zi"],"„Åö":["zu"],"„Åú":["ze"],"„Åû":["zo"],"„Å†":["da"],"„Å¢":["di"],"„Å•":["du"],"„Åß":["de"],"„Å©":["do"],"„Å∞":["ba"],"„Å≥":["bi"],"„Å∂":["bu"],"„Åπ":["be"],"„Åº":["bo"],"„Å±":["pa"],"„Å¥":["pi"],"„Å∑":["pu"],"„Å∫":["pe"],"„ÅΩ":["po"],"„Çê":["wyi"],"„Çë":["wye"],"„Çî":["vu"]}});const remSize=parseInt(getComputedStyle(document.documentElement).fontSize),gamePanel=document.getElementById("gamePanel"),infoPanel=document.getElementById("infoPanel"),countPanel=document.getElementById("countPanel"),scorePanel=document.getElementById("scorePanel"),startButton=document.getElementById("startButton"),romaNode=document.getElementById("roma"),originalTextNode=document.getElementById("originalText"),translatedTextNode=document.getElementById("translatedText"),aa=document.getElementById("aa"),gameTime=60,tmpCanvas=document.createElement("canvas"),mode=document.getElementById("mode"),categories=[...document.getElementById("courseOption").options].map(e=>e.value.toLowerCase()),htmlLang=document.documentElement.lang,ttsLang=getTTSLang();let playing,countdowning,typeTimer;const bgm=new Audio("/emoji-typing/mp3/bgm.mp3");bgm.volume=.4,bgm.loop=!0;let errorCount=0,normalCount=0,solveCount=0,guide=!0;const problems={};let problem;const layout104={default:["{esc} ` 1 2 3 4 5 6 7 8 9 0 -","{tab} q w e r t y u i o p [ ]","{lock} a s d f g h j k l ;","{shift} z x c v b n m , .","üåè {altLeft} {space} {altRight}"],shift:["{esc} ~ ! @ # $ % ^ & * ( ) _","{tab} Q W E R T Y U I O P { }","{lock} A S D F G H J K L :","{shift} Z X C V B N M < >","üåè {altLeft} {space} {altRight}"]},layout109={default:["{esc} 1 2 3 4 5 6 7 8 9 0 -","{tab} q w e r t y u i o p","{lock} a s d f g h j k l ;","{shift} z x c v b n m , .","üåè ÁÑ°Â§âÊèõ {space} Â§âÊèõ"],shift:[`{esc} ! " # $ % & ' ( ) =`,"{tab} Q W E R T Y U I O P","{lock} A S D F G H J K L +","{shift} Z X C V B N M < >","üåè ÁÑ°Â§âÊèõ {space} Â§âÊèõ"]},keyboardDisplay={"{esc}":"Esc","{tab}":"Tab","{lock}":"Caps","{shift}":"Shift","{space}":" ","{altLeft}":"Alt","{altRight}":"Alt","üåè":navigator.language.startsWith("ja")?"üáØüáµ":"üá∫üá∏"},simpleKeyboard=new SimpleKeyboard.default({layout:navigator.language.startsWith("ja")?layout109:layout104,display:keyboardDisplay,onInit:()=>{document.getElementById("keyboard").classList.add("d-none")},onKeyPress:e=>{switch(e){case"{esc}":return typeEventKey("Escape");case"{space}":return typeEventKey(" ");case"ÁÑ°Â§âÊèõ":case"{altLeft}":return typeEventKey("NonConvert");case"Â§âÊèõ":case"{altRight}":return typeEventKey("Convert");case"üåè":{simpleKeyboard.options.layout==layout109?(keyboardDisplay["üåè"]="üá∫üá∏",simpleKeyboard.setOptions({layout:layout104,display:keyboardDisplay})):(keyboardDisplay["üåè"]="üáØüáµ",simpleKeyboard.setOptions({layout:layout109,display:keyboardDisplay}));break}case"{shift}":case"{lock}":{const e=simpleKeyboard.options.layoutName=="default"?"shift":"default";simpleKeyboard.setOptions({layoutName:e});break}default:return typeEventKey(e)}}}),audioContext=new AudioContext,audioBufferCache={};loadAudio("end","/emoji-typing/mp3/end.mp3"),loadAudio("keyboard","/emoji-typing/mp3/keyboard.mp3"),loadAudio("correct","/emoji-typing/mp3/correct.mp3"),loadAudio("incorrect","/emoji-typing/mp3/cat.mp3");let englishVoices=[];loadVoices(),loadConfig();function loadConfig(){if(localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark"),localStorage.getItem("bgm")!=1&&(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none")),htmlLang=="ja"&&localStorage.getItem("furigana")==1){const e=document.getElementById("addFurigana");addFurigana(e),e.setAttribute("data-done",!0)}}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function toggleBGM(){localStorage.getItem("bgm")==1?(document.getElementById("bgmOn").classList.add("d-none"),document.getElementById("bgmOff").classList.remove("d-none"),localStorage.setItem("bgm",0),bgm.pause()):(document.getElementById("bgmOn").classList.remove("d-none"),document.getElementById("bgmOff").classList.add("d-none"),localStorage.setItem("bgm",1),bgm.play())}function toggleKeyboard(){const e=document.getElementById("virtualKeyboardOn"),t=document.getElementById("virtualKeyboardOff");e.classList.contains("d-none")?(e.classList.remove("d-none"),t.classList.add("d-none"),document.getElementById("keyboard").classList.remove("d-none"),resizeFontSize(aa)):(e.classList.add("d-none"),t.classList.remove("d-none"),document.getElementById("keyboard").classList.add("d-none"),document.getElementById("guideSwitch").checked=!1,guide=!1,resizeFontSize(aa))}function toggleGuide(e){e.target.checked?guide=!0:guide=!1}function addFurigana(){if(htmlLang!="ja")return;const e=document.getElementById("addFurigana");e.getAttribute("data-done")?(localStorage.setItem("furigana",0),location.reload()):(import("https://marmooo.github.io/yomico/yomico.min.js").then(e=>{e.yomico("/emoji-typing/ja/index.yomi")}),localStorage.setItem("furigana",1),e.setAttribute("data-done",!0))}function changeLang(){const e=document.getElementById("lang"),t=e.options[e.selectedIndex].value;location.href=`/emoji-typing/${t}/`}function getTTSLang(){switch(htmlLang){case"en":return"en-US";case"ja":return"ja-JP"}}async function playAudio(e,t){const s=await loadAudio(e,audioBufferCache[e]),n=audioContext.createBufferSource();if(n.buffer=s,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}async function loadAudio(e,t){if(audioBufferCache[e])return audioBufferCache[e];const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}function unlockAudio(){audioContext.resume()}function loadVoices(){const e=new Promise(e=>{let t=speechSynthesis.getVoices();if(t.length!==0)e(t);else{let n=!1;speechSynthesis.addEventListener("voiceschanged",()=>{n=!0,t=speechSynthesis.getVoices(),e(t)}),setTimeout(()=>{n||document.getElementById("noTTS").classList.remove("d-none")},1e3)}}),t=["com.apple.speech.synthesis.voice.Bahh","com.apple.speech.synthesis.voice.Albert","com.apple.speech.synthesis.voice.Hysterical","com.apple.speech.synthesis.voice.Organ","com.apple.speech.synthesis.voice.Cellos","com.apple.speech.synthesis.voice.Zarvox","com.apple.speech.synthesis.voice.Bells","com.apple.speech.synthesis.voice.Trinoids","com.apple.speech.synthesis.voice.Boing","com.apple.speech.synthesis.voice.Whisper","com.apple.speech.synthesis.voice.Deranged","com.apple.speech.synthesis.voice.GoodNews","com.apple.speech.synthesis.voice.BadNews","com.apple.speech.synthesis.voice.Bubbles"];e.then(e=>{englishVoices=e.filter(e=>e.lang==ttsLang).filter(e=>!t.includes(e.voiceURI))})}function loopVoice(e,t){speechSynthesis.cancel();const n=new SpeechSynthesisUtterance(e);n.voice=englishVoices[Math.floor(Math.random()*englishVoices.length)],n.lang=ttsLang;for(let e=0;e<t;e++)speechSynthesis.speak(n)}function nextProblem(){playAudio("correct",.3),solveCount+=1,typable()}function removeGuide(e){e==" "&&(e="{space}");const t=simpleKeyboard.getButtonElement(e);if(t)t.classList.remove("guide"),simpleKeyboard.setOptions({layoutName:"default"});else{const e=simpleKeyboard.getButtonElement("{shift}");e&&e.classList.remove("guide")}}function showGuide(e){e==" "&&(e="{space}");const t=simpleKeyboard.getButtonElement(e);if(t)t.classList.add("guide");else{const e=simpleKeyboard.getButtonElement("{shift}");e&&e.classList.add("guide")}}function typeEvent(e){switch(e.code){case"AltLeft":return typeEventKey("NonConvert");case"AltRight":return typeEventKey("Convert");case"Space":e.preventDefault();default:return typeEventKey(e.key)}}function typeEventKey(e){switch(e){case"NonConvert":{const e="visible",t=romaNode.children;t[1].style.visibility=e,t[2].style.visibility=e,downTime(5);return}case"Convert":{loopVoice(problem.yomi,1);return}case"Escape":startGame();return;case" ":if(!playing){startGame();return}}if(e.length==1){e=e.toLowerCase();const t=problem.romaji,n=t.currentNode,s=t.input(e);if(s){playAudio("keyboard"),normalCount+=1;const s=t.remainedRomaji,o=romaNode.children;o[0].textContent+=e,o[1].textContent=s[0],o[2].textContent=s.slice(1);for(const e of n.children.keys())removeGuide(e);t.isEnd()?nextProblem():guide&&showGuide(s[0])}else playAudio("incorrect",.3),errorCount+=1}}function resizeFontSize(e){function h(e,t){const n=tmpCanvas.getContext("2d");n.font=t;const s=n.measureText(e);return s.width}function f(e,t,n,s){const o=e.split(`
`),a=t+"px "+n;let i=0;for(let e=0;e<o.length;e++){const t=h(o[e],a);i<t&&(i=t)}return[i,t*o.length*s]}function m(e){const t=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),n=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom);return[t,n]}const n=getComputedStyle(e),c=n.fontFamily,t=parseFloat(n.fontSize),l=parseFloat(n.lineHeight)/t,d=document.getElementById("aaOuter").offsetHeight,u=infoPanel.clientWidth,i=[u,d],a=f(e.textContent,t,c,l),r=m(n),o=t*(i[0]-r[0])/a[0]*.9,s=t*(i[1]-r[1])/a[1]*.9;s<o?s<remSize?e.style.fontSize=remSize+"px":e.style.fontSize=s+"px":o<remSize?e.style.fontSize=remSize+"px":e.style.fontSize=o+"px"}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}function kanaToHira(e){return e.replace(/[„Ç°-„É∂]/g,e=>{const t=e.charCodeAt(0)-96;return String.fromCharCode(t)})}function typable(){const n=problem,r=document.getElementById("courseOption"),c=categories[r.selectedIndex],s=problems[c];problem=s[getRandomInt(0,s.length)];const o=problem.emojis;aa.textContent=o[getRandomInt(0,o.length)];const t=new i(kanaToHira(problem.yomi));originalTextNode.textContent=problem.yomi,translatedTextNode.textContent=problem.ja,problem.romaji=t;const e=romaNode.children;e[0].textContent=t.inputedRomaji,e[1].textContent=t.remainedRomaji[0],e[2].textContent=t.remainedRomaji.slice(1),mode.textContent=="EASY"&&loopVoice(problem.yomi,1);const a=mode.textContent=="EASY"?"visible":"hidden";if(e[1].style.visibility=a,e[2].style.visibility=a,resizeFontSize(aa),guide){if(n){const e=n.romaji.currentNode;if(e)for(const t of e.children.keys())removeGuide(t)}showGuide(problem.roma[0])}}function countdown(){if(countdowning)return;countdowning=!0,changeUIEmoji(),normalCount=errorCount=solveCount=0,document.getElementById("guideSwitch").disabled=!0,document.getElementById("virtualKeyboard").disabled=!0,gamePanel.classList.add("d-none"),infoPanel.classList.add("d-none"),countPanel.classList.remove("d-none"),counter.textContent=3;const e=setInterval(()=>{const t=document.getElementById("counter"),n=["skyblue","greenyellow","violet","tomato"];if(parseInt(t.textContent)>1){const e=parseInt(t.textContent)-1;t.style.backgroundColor=n[e],t.textContent=e}else countdowning=!1,playing=!0,clearInterval(e),document.getElementById("guideSwitch").disabled=!1,document.getElementById("virtualKeyboard").disabled=!1,gamePanel.classList.remove("d-none"),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),scorePanel.classList.add("d-none"),resizeFontSize(aa),typable(),startTypeTimer(),localStorage.getItem("bgm")==1&&bgm.play(),startButton.disabled=!1},1e3)}function startGame(){clearInterval(typeTimer),initTime(),countdown(),countPanel.classList.remove("d-none"),scorePanel.classList.add("d-none")}function startTypeTimer(){const e=document.getElementById("time");typeTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(typeTimer),bgm.pause(),playAudio("end"),scoring())},1e3)}function downTime(e){const t=document.getElementById("time"),s=parseInt(t.textContent),n=s-e;n<0?t.textContent=0:t.textContent=n}function initTime(){document.getElementById("time").textContent=gameTime}function scoring(){playing=!1,infoPanel.classList.remove("d-none"),gamePanel.classList.add("d-none"),countPanel.classList.add("d-none"),scorePanel.classList.remove("d-none");let e=parseInt(document.getElementById("time").textContent);e<60&&(e=gameTime-e);const t=(normalCount/e).toFixed(2);document.getElementById("totalType").textContent=normalCount+errorCount,document.getElementById("typeSpeed").textContent=t,document.getElementById("errorType").textContent=errorCount}function changeMode(e){e.target.textContent=="EASY"?e.target.textContent="HARD":e.target.textContent="EASY"}function selectRandomEmoji(){const s=categories[getRandomInt(0,categories.length)],e=problems[s],t=e[getRandomInt(0,e.length)],n=t.emojis,o=n[getRandomInt(0,n.length)];return[o,t.roma]}function changeUIEmoji(){document.getElementById("counter-emoji").textContent=selectRandomEmoji()[0],document.getElementById("score-emoji").textContent=selectRandomEmoji()[0]}function initProblems(){fetch(`/emoji-typing/data/${htmlLang}.csv`).then(e=>e.text()).then(e=>{let t;e.trimEnd().split(`
`).forEach(e=>{const[o,s,n,i,a]=e.split(",");if(s in problems===!1&&(problems[s]=[]),t==n)problems[s].at(-1).emojis.push(o);else if(htmlLang=="en"){const e={emojis:[o],roma:n,yomi:n,ja:n};problems[s].push(e)}else{const e={emojis:[o],roma:n,yomi:i,ja:a};problems[s].push(e)}t=n})})}function setTranslation(){const e={attributeFilter:["lang"],attributes:!0};new MutationObserver(()=>{htmlLang=="en"?originalTextNode.classList.add("d-none"):originalTextNode.classList.remove("d-none");const e=document.documentElement.lang;e==htmlLang?translatedTextNode.classList.add("d-none"):translatedTextNode.classList.remove("d-none")}).observe(document.documentElement,e)}resizeFontSize(aa),initProblems(),setTranslation(),startButton.onclick=startGame,document.getElementById("toggleDarkMode").onclick=toggleDarkMode;const furiganaButton=document.getElementById("addFurigana");furiganaButton&&(furiganaButton.onclick=addFurigana),document.getElementById("toggleBGM").onclick=toggleBGM,document.getElementById("virtualKeyboard").onclick=toggleKeyboard,window.addEventListener("resize",()=>{resizeFontSize(aa)}),document.getElementById("mode").onclick=changeMode,document.getElementById("guideSwitch").onchange=toggleGuide,document.getElementById("lang").onchange=changeLang,document.addEventListener("keydown",typeEvent),document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})